name: Version Bump

on:
  push:
    branches: [ main ]
    paths-ignore:
      - '.github/workflows/**'
      - 'README.md'

jobs:
  bump-version:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Bump version
      id: bump
      run: |
        # Extract current version from extract_worklogs.py
        CURRENT_VERSION=$(grep '^VERSION = ' extract_worklogs.py | cut -d'"' -f2)
        echo "Current version: $CURRENT_VERSION"

        # Split version into major, minor, patch
        IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
        MAJOR=${VERSION_PARTS[0]}
        MINOR=${VERSION_PARTS[1]}
        PATCH=${VERSION_PARTS[2]}

        # Bump patch version
        NEW_PATCH=$((PATCH + 1))
        NEW_VERSION="$MAJOR.$MINOR.$NEW_PATCH"
        echo "New version: $NEW_VERSION"

        # Update version in extract_worklogs.py
        sed -i "s/VERSION = \"$CURRENT_VERSION\"/VERSION = \"$NEW_VERSION\"/" extract_worklogs.py

        # Update version in README.md
        sed -i "s/Version: $CURRENT_VERSION/Version: $NEW_VERSION/" README.md

        # Update version in CLAUDE.md if present
        if grep -q "Version: $CURRENT_VERSION" CLAUDE.md 2>/dev/null; then
          sed -i "s/Version: $CURRENT_VERSION/Version: $NEW_VERSION/" CLAUDE.md
        fi

        # Update version in IMPROVEMENTS.md if present
        if grep -q "Version: $CURRENT_VERSION" IMPROVEMENTS.md 2>/dev/null; then
          sed -i "s/Version: $CURRENT_VERSION/Version: $NEW_VERSION/" IMPROVEMENTS.md
        fi

        # Update "Last Updated" timestamp in IMPROVEMENTS.md
        CURRENT_DATE=$(date +%Y-%m-%d)
        if grep -q "Last Updated:" IMPROVEMENTS.md 2>/dev/null; then
          sed -i "s/Last Updated: .*/Last Updated: $CURRENT_DATE/" IMPROVEMENTS.md
        fi

        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

    - name: Commit version bump
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"

        if git diff --quiet; then
          echo "No version changes to commit"
          exit 0
        fi

        git add extract_worklogs.py README.md CLAUDE.md IMPROVEMENTS.md
        git commit -m "chore: bump version to ${{ steps.bump.outputs.new_version }} [skip ci]"

    - name: Push changes
      uses: ad-m/github-push-action@master
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        branch: main
